/*
 Copyright (c) 2014, Pixel & Tonic, Inc.
 @license   http://buildwithcraft.com/license Craft License Agreement
 @see       http://buildwithcraft.com
 @package   craft.app.resources
*/
!function(t){var s=Garnish.Base.extend({authManager:null,$alerts:null,$header:null,$headerActionsList:null,$siteName:null,$nav:null,$overflowNavMenuItem:null,$overflowNavMenuBtn:null,$overflowNavMenu:null,$overflowNavMenuList:null,$notificationWrapper:null,$notificationContainer:null,$main:null,$content:null,$collapsibleTables:null,navItems:null,totalNavItems:null,visibleNavItems:null,totalNavWidth:null,showingOverflowNavMenu:!1,fixedNotifications:!1,runningTaskInfo:null,trackTaskProgressTimeout:null,taskProgressIcon:null,$upgradePromo:null,upgradeModal:null,init:function(){0!=Craft.authTimeout&&(this.authManager=new Craft.AuthManager),this.$alerts=t("#alerts"),this.$header=t("#header"),this.$headerActionsList=this.$header.find("#header-actions"),this.$siteName=this.$header.find("h2"),this.$nav=t("#nav"),this.$notificationWrapper=t("#notifications-wrapper"),this.$notificationContainer=t("#notifications"),this.$main=t("#main"),this.$content=t("#content"),this.$collapsibleTables=this.$content.find("table.collapsible"),this.$upgradePromo=t("#upgradepromo > a"),this.onActionItemListResize(),this.addListener(this.$headerActionsList,"resize","onActionItemListResize"),this.navItems=[],this.totalNavWidth=s.baseNavWidth;var i=this.$nav.children();this.visibleNavItems=this.totalNavItems=i.length;for(var e=0;e<this.totalNavItems;e++){var a=t(i[e]),n=a.width();this.navItems.push(a),this.totalNavWidth+=n}this.addListener(Garnish.$win,"resize","onWindowResize"),this.onWindowResize(),this.addListener(Garnish.$win,"scroll","updateFixedNotifications"),this.updateFixedNotifications(),i=this.$notificationContainer.children(".error"),e=this.$notificationContainer.children(":not(.error)"),i.delay(2*s.notificationDuration).velocity("fadeOut"),e.delay(s.notificationDuration).velocity("fadeOut"),this.$alerts.length&&this.initAlerts();var r=t("form[data-saveshortcut]:first");1==r.length&&this.addListener(Garnish.$doc,"keydown",function(s){return(s.metaKey||s.ctrlKey)&&s.keyCode==Garnish.S_KEY&&(s.preventDefault(),this.trigger("beforeSaveShortcut"),r.data("saveshortcut-redirect")&&t('<input type="hidden" name="redirect" value="'+r.data("saveshortcut-redirect")+'"/>').appendTo(r),r.submit()),!0}),Garnish.$win.on("load",t.proxy(function(){if(this.$confirmUnloadForms=t("form[data-confirm-unload]"),this.$confirmUnloadForms.length){Craft.forceConfirmUnload||(this.initialFormValues=[]);for(var s=0;s<this.$confirmUnloadForms.length;s++){var i=t(this.$confirmUnloadForms);Craft.forceConfirmUnload||(this.initialFormValues[s]=i.serialize()),this.addListener(i,"submit",function(){this.removeListener(Garnish.$win,"beforeunload")})}this.addListener(Garnish.$win,"beforeunload",function(s){for(var i=0;i<this.$confirmUnloadForms.length;i++)if(Craft.forceConfirmUnload||this.initialFormValues[i]!=t(this.$confirmUnloadForms[i]).serialize())return i=Craft.t("Any changes will be lost if you leave this page."),s?s.originalEvent.returnValue=i:window.event.returnValue=i,i})}},this)),this.addListener(this.$upgradePromo,"click","showUpgradeModal"),i=t(""),i.length&&new Craft.WrongEditionModal(i)},onWindowResize:function(){this.onWindowResize._cpWidth=Math.min(Garnish.$win.width(),s.maxWidth),this.updateResponsiveNav(),this.updateResponsiveTables()},onActionItemListResize:function(){this.$siteName.css("max-width","calc(100% - "+(this.$headerActionsList.width()+14)+"px)")},updateResponsiveNav:function(){if(this.onWindowResize._cpWidth<this.totalNavWidth)if(this.showingOverflowNavMenu||(this.$overflowNavMenuBtn?this.$overflowNavMenuItem.show():(this.$overflowNavMenuItem=t("<li/>").appendTo(this.$nav),this.$overflowNavMenuBtn=t('<a class="menubtn" title="'+Craft.t("More")+'">â€¦</a>').appendTo(this.$overflowNavMenuItem),this.$overflowNavMenu=t('<div id="overflow-nav" class="menu" data-align="right"/>').appendTo(this.$overflowNavMenuItem),this.$overflowNavMenuList=t("<ul/>").appendTo(this.$overflowNavMenu),new Garnish.MenuBtn(this.$overflowNavMenuBtn)),this.showingOverflowNavMenu=!0),this.$nav.height()>s.navHeight){do this.addLastVisibleNavItemToOverflowMenu();while(this.$nav.height()>s.navHeight&&0<this.visibleNavItems)}else{for(;this.$nav.height()==s.navHeight&&this.visibleNavItems<this.totalNavItems;)this.addFirstOverflowNavItemToMainMenu();this.addLastVisibleNavItemToOverflowMenu()}else if(this.showingOverflowNavMenu){for(this.$overflowNavMenuItem.hide();this.visibleNavItems<this.totalNavItems;)this.addFirstOverflowNavItemToMainMenu();this.showingOverflowNavMenu=!1}},updateResponsiveTables:function(){if(Garnish.isMobileBrowser()){for(this.updateResponsiveTables._contentWidth=this.$content.width(),this.updateResponsiveTables._i=0;this.updateResponsiveTables._i<this.$collapsibleTables.length;this.updateResponsiveTables._i++)this.updateResponsiveTables._$table=t(this.$collapsibleTables[this.updateResponsiveTables._i]),this.updateResponsiveTables._check=!1,"undefined"!=typeof this.updateResponsiveTables._lastContentWidth?(this.updateResponsiveTables._isLinear=this.updateResponsiveTables._$table.hasClass("collapsed"),this.updateResponsiveTables._contentWidth>this.updateResponsiveTables._lastContentWidth?this.updateResponsiveTables._isLinear&&(this.updateResponsiveTables._$table.removeClass("collapsed"),this.updateResponsiveTables._check=!0):this.updateResponsiveTables._isLinear||(this.updateResponsiveTables._check=!0)):this.updateResponsiveTables._check=!0,this.updateResponsiveTables._check&&this.updateResponsiveTables._$table.width()>this.updateResponsiveTables._contentWidth&&this.updateResponsiveTables._$table.addClass("collapsed");this.updateResponsiveTables._lastContentWidth=this.updateResponsiveTables._contentWidth}},addLastVisibleNavItemToOverflowMenu:function(){this.navItems[this.visibleNavItems-1].prependTo(this.$overflowNavMenuList),this.visibleNavItems--},addFirstOverflowNavItemToMainMenu:function(){this.navItems[this.visibleNavItems].insertBefore(this.$overflowNavMenuItem),this.visibleNavItems++},updateFixedNotifications:function(){this.updateFixedNotifications._headerHeight=this.$header.height(),Garnish.$win.scrollTop()>this.updateFixedNotifications._headerHeight?this.fixedNotifications||(this.$notificationWrapper.addClass("fixed"),this.fixedNotifications=!0):this.fixedNotifications&&(this.$notificationWrapper.removeClass("fixed"),this.fixedNotifications=!1)},displayNotification:function(i,e){var a=s.notificationDuration;"error"==i&&(a*=2),t('<div class="notification '+i+'">'+e+"</div>").appendTo(this.$notificationContainer).hide().velocity("fadeIn",{display:"inline-block",duration:"fast"}).delay(a).velocity("fadeOut"),this.trigger("displayNotification",{notificationType:i,message:e})},displayNotice:function(t){this.displayNotification("notice",t)},displayError:function(t){t||(t=Craft.t("An unknown error occurred.")),this.displayNotification("error",t)},fetchAlerts:function(){Craft.queueActionRequest("app/getCpAlerts",{path:Craft.path},t.proxy(this,"displayAlerts"))},displayAlerts:function(s){if(Garnish.isArray(s)&&s.length){this.$alerts=t('<ul id="alerts"/>').insertBefore(t("#header"));for(var i=0;i<s.length;i++)t("<li>"+s[i]+"</li>").appendTo(this.$alerts);s=this.$alerts.height(),this.$alerts.height(0).velocity({height:s},"fast",t.proxy(function(){this.$alerts.height("auto")},this)),this.initAlerts()}},initAlerts:function(){var s=this.$alerts.find(".domain-mismatch:first");s.length&&this.addListener(s,"click",t.proxy(function(i){i.preventDefault(),confirm(Craft.t("Are you sure you want to transfer your license to this domain?"))&&Craft.queueActionRequest("app/transferLicenseToCurrentDomain",t.proxy(function(t,i){"success"==i&&(t.success?(s.parent().remove(),this.displayNotice(Craft.t("License transferred."))):Craft.cp.displayError(t.error))},this))},this));for(var i=this.$alerts.find('a[class^="shun:"]'),e=0;e<i.length;e++)this.addListener(i[e],"click",t.proxy(function(s){s.preventDefault();var i=t(s.currentTarget);s={message:i.prop("className").substr(5)},Craft.queueActionRequest("app/shunCpAlert",s,t.proxy(function(t,s){"success"==s&&(t.success?i.parent().remove():Craft.cp.displayError(t.error))},this))},this))},checkForUpdates:function(){Craft.queueActionRequest("app/checkForUpdates",t.proxy(function(t){this.displayUpdateInfo(t),this.trigger("checkForUpdates",{updateInfo:t})},this))},displayUpdateInfo:function(s){if(this.$headerActionsList.children("li.updates").remove(),s.total){var i=1==s.total?Craft.t("1 update available"):Craft.t("{num} updates available",{num:s.total});t('<li class="updates'+(s.critical?" critical":"")+'"><a data-icon="newstamp" href="'+Craft.getUrl("updates")+'" title="'+i+'"><span>'+s.total+"</span></a></li>").prependTo(this.$headerActionsList),t("#footer-updates").text(i)}},runPendingTasks:function(){Craft.runTasksAutomatically?Craft.queueActionRequest("tasks/runPendingTasks",t.proxy(function(t,s){"success"==s&&this.trackTaskProgress(0)},this)):this.trackTaskProgress(0)},trackTaskProgress:function(s){this.trackTaskProgressTimeout||(this.trackTaskProgressTimeout=setTimeout(t.proxy(function(){Craft.queueActionRequest("tasks/getRunningTaskInfo",t.proxy(function(t,s){"success"==s&&(this.trackTaskProgressTimeout=null,this.setRunningTaskInfo(t,!0),"running"==t.status?this.trackTaskProgress():"pending"==t.status&&this.trackTaskProgress(3e4))},this))},this),"undefined"!=typeof s?s:1e3))},stopTrackingTaskProgress:function(){this.trackTaskProgressTimeout&&(clearTimeout(this.trackTaskProgressTimeout),this.trackTaskProgressTimeout=null)},setRunningTaskInfo:function(t,s){(this.runningTaskInfo=t)?(this.taskProgressIcon||(this.taskProgressIcon=new i),"running"==t.status||"pending"==t.status?(this.taskProgressIcon.hideFailMode(),this.taskProgressIcon.setDescription(t.description),this.taskProgressIcon.setProgress(t.progress,s)):"error"==t.status&&this.taskProgressIcon.showFailMode()):this.taskProgressIcon&&(this.taskProgressIcon.hideFailMode(),this.taskProgressIcon.complete(),delete this.taskProgressIcon)},showUpgradeModal:function(){this.upgradeModal?this.upgradeModal.show():this.upgradeModal=new Craft.UpgradeModal}},{maxWidth:1051,navHeight:38,baseNavWidth:30,notificationDuration:2e3});Craft.cp=new s;var i=Garnish.Base.extend({$li:null,$a:null,hud:null,completed:!1,failMode:!1,_canvasSupported:null,_$bgCanvas:null,_$staticCanvas:null,_$hoverCanvas:null,_$failCanvas:null,_staticCtx:null,_hoverCtx:null,_canvasSize:null,_arcPos:null,_arcRadius:null,_lineWidth:null,_arcStartPos:0,_arcEndPos:0,_arcStartStepSize:null,_arcEndStepSize:null,_arcStep:null,_arcStepTimeout:null,_arcAnimateCallback:null,_progressBar:null,init:function(){if(this.$li=t("<li/>").prependTo(Craft.cp.$headerActionsList),this.$a=t('<a id="taskicon"/>').appendTo(this.$li),this._canvasSupported=!!document.createElement("canvas").getContext){var s=1<window.devicePixelRatio?2:1;this._canvasSize=30*s,this._arcPos=this._canvasSize/2,this._arcRadius=7*s,this._lineWidth=3*s,this._$bgCanvas=this._createCanvas("bg","#61666b"),this._$staticCanvas=this._createCanvas("static","#d7d9db"),this._$hoverCanvas=this._createCanvas("hover","#fff"),this._$failCanvas=this._createCanvas("fail","#da5a47").hide(),this._staticCtx=this._$staticCanvas[0].getContext("2d"),this._hoverCtx=this._$hoverCanvas[0].getContext("2d"),this._drawArc(this._$bgCanvas[0].getContext("2d"),0,1),this._drawArc(this._$failCanvas[0].getContext("2d"),0,1)}else this._progressBar=new Craft.ProgressBar(this.$a),this._progressBar.showProgressBar();this.addListener(this.$a,"click","toggleHud")},setDescription:function(t){this.$a.attr("title",t)},setProgress:function(t,s){this._canvasSupported?s?this._animateArc(0,t):this._setArc(0,t):this._progressBar.setProgressPercentage(100*t)},complete:function(){this.completed=!0,this._canvasSupported?this._animateArc(0,1,t.proxy(function(){this._$bgCanvas.velocity("fadeOut"),this._animateArc(1,1,t.proxy(function(){this.$li.remove(),this.destroy()},this))},this)):(this._progressBar.setProgressPercentage(100),this.$a.velocity("fadeOut"))},showFailMode:function(){this.failMode||(this.failMode=!0,this._canvasSupported?(this._$bgCanvas.hide(),this._$staticCanvas.hide(),this._$hoverCanvas.hide(),this._$failCanvas.show()):(this._progressBar.$progressBar.css("border-color","#da5a47"),this._progressBar.$innerProgressBar.css("background-color","#da5a47"),this._progressBar.setProgressPercentage(50)),this.setDescription(Craft.t("Failed task")))},hideFailMode:function(){this.failMode&&(this.failMode=!1,this._canvasSupported?(this._$bgCanvas.show(),this._$staticCanvas.show(),this._$hoverCanvas.show(),this._$failCanvas.hide()):(this._progressBar.$progressBar.css("border-color",""),this._progressBar.$innerProgressBar.css("background-color",""),this._progressBar.setProgressPercentage(50)))},toggleHud:function(){this.hud?this.hud.toggle():this.hud=new e},_createCanvas:function(s,i){var e=t('<canvas id="taskicon-'+s+'" width="'+this._canvasSize+'" height="'+this._canvasSize+'"/>').appendTo(this.$a),a=e[0].getContext("2d");return a.strokeStyle=i,a.lineWidth=this._lineWidth,a.lineCap="round",e},_setArc:function(t,s){this._arcStartPos=t,this._arcEndPos=s,this._drawArc(this._staticCtx,t,s),this._drawArc(this._hoverCtx,t,s)},_drawArc:function(t,s,i){t.clearRect(0,0,this._canvasSize,this._canvasSize),t.beginPath(),t.arc(this._arcPos,this._arcPos,this._arcRadius,(1.5+2*s)*Math.PI,(1.5+2*i)*Math.PI),t.stroke(),t.closePath()},_animateArc:function(t,s,i){this._arcStepTimeout&&clearTimeout(this._arcStepTimeout),this._arcStep=0,this._arcStartStepSize=(t-this._arcStartPos)/10,this._arcEndStepSize=(s-this._arcEndPos)/10,this._arcAnimateCallback=i,this._takeNextArcStep()},_takeNextArcStep:function(){this._setArc(this._arcStartPos+this._arcStartStepSize,this._arcEndPos+this._arcEndStepSize),this._arcStep++,10>this._arcStep?this._arcStepTimeout=setTimeout(t.proxy(this,"_takeNextArcStep"),50):this._arcAnimateCallback&&this._arcAnimateCallback()}}),e=Garnish.HUD.extend({icon:null,tasksById:null,completedTasks:null,updateTasksTimeout:null,completed:!1,init:function(){this.icon=Craft.cp.taskProgressIcon,this.tasksById={},this.completedTasks=[],this.base(this.icon.$a),this.$body.attr("id","tasks-hud"),Craft.cp.runningTaskInfo&&"error"!=Craft.cp.runningTaskInfo.status&&this.showTaskInfo([Craft.cp.runningTaskInfo]),this.$hud.trigger("resize")},onShow:function(){Craft.cp.stopTrackingTaskProgress(),this.updateTasks(),this.base()},onHide:function(){if(this.updateTasksTimeout&&clearTimeout(this.updateTasksTimeout),this.completed||Craft.cp.trackTaskProgress(),this.completedTasks.length){for(var t=0;t<this.completedTasks.length;t++)this.completedTasks[t].destroy();this.completedTasks=[]}this.base()},updateTasks:function(){this.completed=!1,Craft.postActionRequest("tasks/getTaskInfo",t.proxy(function(t,s){"success"==s&&this.showTaskInfo(t)},this))},showTaskInfo:function(s){var i=[];if(s)for(var a=0;a<s.length;a++)i.push(s[a].id);for(var n in this.tasksById)Craft.inArray(n,i)||(this.tasksById[n].complete(),this.completedTasks.push(this.tasksById[n]),delete this.tasksById[n]);if(s&&s.length){for(n=i=!1,a=0;a<s.length;a++){var r=s[a];if(i||"running"!=r.status?n||"error"!=r.status||(n=!0):i=!0,this.tasksById[r.id])this.tasksById[r.id].updateStatus(r);else{this.tasksById[r.id]=new e.Task(this,r);for(var o=a+1;o<s.length;o++)if(this.tasksById[s[o].id]){this.tasksById[r.id].$container.insertBefore(this.tasksById[s[o].id].$container);break}}}i?this.updateTasksTimeout=setTimeout(t.proxy(this,"updateTasks"),500):(this.completed=!0,n&&Craft.cp.setRunningTaskInfo({status:"error"}))}else this.completed=!0,Craft.cp.setRunningTaskInfo(null),this.hide()}});e.Task=Garnish.Base.extend({hud:null,id:null,level:null,description:null,status:null,progress:null,$container:null,$statusContainer:null,$descriptionContainer:null,_progressBar:null,init:function(s,i){this.hud=s,this.id=i.id,this.level=i.level,this.description=i.description,this.$container=t('<div class="task"/>').appendTo(this.hud.$body),this.$statusContainer=t('<div class="task-status"/>').appendTo(this.$container),this.$descriptionContainer=t('<div class="task-description"/>').appendTo(this.$container).text(i.description),this.$container.data("task",this),0!=this.level&&(this.$container.css("padding-"+Craft.left,24+24*this.level),t('<div class="indent" data-icon="'+("ltr"==Craft.orientation?"rarr":"larr")+'"/>').appendTo(this.$descriptionContainer)),this.updateStatus(i)},updateStatus:function(s){if(this.status!=s.status)switch(this.$statusContainer.empty(),this.status=s.status,this.status){case"pending":this.$statusContainer.text(Craft.t("Pending"));break;case"running":this._progressBar=new Craft.ProgressBar(this.$statusContainer),this._progressBar.showProgressBar();break;case"error":if(t('<span class="error">'+Craft.t("Failed")+"</span>").appendTo(this.$statusContainer),0==this.level){var i=t('<a class="menubtn error" title="'+Craft.t("Options")+'"/>').appendTo(this.$statusContainer);t('<div class="menu"><ul><li><a data-action="rerun">'+Craft.t("Try again")+'</a></li><li><a data-action="cancel">'+Craft.t("Cancel")+"</a></li></ul></div>").appendTo(this.$statusContainer),new Garnish.MenuBtn(i,{onOptionSelect:t.proxy(this,"performErrorAction")})}}"running"==this.status&&(this._progressBar.setProgressPercentage(100*s.progress),0==this.level&&Craft.cp.setRunningTaskInfo(s,!0))},performErrorAction:function(s){for(var i=this.$container.nextAll(),e=0;e<i.length;e++){var a=t(i[e]).data("task");if(!a||0==a.level)break;a.destroy()}switch(t(s).data("action")){case"rerun":Craft.postActionRequest("tasks/rerunTask",{taskId:this.id},t.proxy(function(t,s){"success"==s&&(this.updateStatus(t),this.hud.completed&&this.hud.updateTasks())},this));break;case"cancel":Craft.postActionRequest("tasks/deleteTask",{taskId:this.id},t.proxy(function(t,s){"success"==s&&(this.destroy(),this.hud.completed&&this.hud.updateTasks())},this))}},complete:function(){this.$statusContainer.empty(),t('<div data-icon="check"/>').appendTo(this.$statusContainer)},destroy:function(){this.hud.tasksById[this.id]&&delete this.hud.tasksById[this.id],this.$container.remove(),this.base()}})}(jQuery);